<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Coração Realista - Debug</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: Arial; }
    .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #0f0; font-size: 1.8em; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .status { position: fixed; top: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #ff0; padding: 12px; font-size: 1.2em; text-align: center; z-index: 999; border-radius: 8px; }
    button { margin-top: 20px; padding: 12px 24px; font-size: 1.2em; background: #0f0; color: black; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>

  <div class="loader">
    <div>Carregando AR...</div>
    <div style="font-size:0.7em; margin:15px;">Permita a câmera!</div>
    <button id="retryBtn" style="display:none;">Tentar novamente câmera</button>
  </div>

  <div class="status">Iniciando... (cheque console para erros)</div>

  <a-scene 
    id="scene"
    embedded 
    vr-mode-ui="enabled: false"
    renderer="alpha: true; logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true; detectionMode: mono; trackingMethod: best;">

    <a-marker preset="hiro">
      <a-entity 
        gltf-model="ur[](https://raw.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb)"
        scale="5 5 5" position="0 1 0"
        animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true">
      </a-entity>
    </a-marker>

    <a-entity light="type: ambient; color: #DDD; intensity: 1.3"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 1" position="1 3 2"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector('#scene');
    const loader = document.querySelector('.loader');
    const status = document.querySelector('.status');
    const retryBtn = document.getElementById('retryBtn');

    scene.addEventListener('loaded', () => {
      status.textContent = 'Cena OK. Tentando câmera...';
      console.log('A-Frame loaded');
    });

    scene.addEventListener('arjs-video-loaded', () => {
      loader.style.display = 'none';
      status.textContent = 'Câmera ativada! Aponte pro Hiro.';
      status.style.color = '#0f0';
      console.log('Video stream loaded success!');
    });

    // Se falhar após 12s, mostra botão retry
    setTimeout(() => {
      if (loader.style.display !== 'none') {
        status.textContent = 'Falha na câmera. Tente novamente ou verifique chrome://settings/content/camera';
        status.style.color = '#f00';
        retryBtn.style.display = 'block';
        console.error('Timeout: no video after permission');
      }
    }, 12000);

    // Botão retry: tenta recarregar página (força novo getUserMedia)
    retryBtn.addEventListener('click', () => {
      status.textContent = 'Recarregando...';
      location.reload();
    });

    // Log extra de erros
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => console.log('Manual getUserMedia success'))
      .catch(err => {
        console.error('getUserMedia error:', err.name, err.message);
        status.textContent += ' Erro: ' + err.name;
      });
  </script>

</body>
</html>