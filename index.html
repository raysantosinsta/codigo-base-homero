<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Projeto AR - Cora√ß√£o Interativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <!-- Gestos -->
  <script src="https://raw.githack.com/fcor/arjs-gestures/master/gesture-detector.js"></script>
  <script src="https://raw.githack.com/fcor/arjs-gestures/master/gesture-handler.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }

    #instructions {
      position: absolute;
      top: 12px;
      left: 12px;
      color: white;
      font-family: sans-serif;
      background: rgba(0,0,0,0.55);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 100;
      max-width: 300px;
    }
  </style>
</head>

<body>

<div id="instructions">
  <strong>Intera√ß√µes:</strong><br>
  ‚Ä¢ 1 dedo: girar<br>
  ‚Ä¢ 2 dedos: zoom / rota√ß√£o<br>
  ‚Ä¢ Toque: zoom + batida forte
</div>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  gesture-detector
  renderer="antialias: true; logarithmicDepthBuffer: true;"
>

  <a-assets>
    <audio id="batida" src="coracao-som.mp3" preload="auto"></audio>
  </a-assets>

  <!-- Camera -->
  <a-entity camera></a-entity>

  <!-- Marker -->
  <a-marker preset="hiro">

    <a-entity
      id="heart"
      class="interactivel"
      gltf-model="url(realistic_human_heart.glb)"
      position="0 0.3 0"
      rotation="0 0 0"

      heart-beat
      onefinger-control
      gesture-handler="enabled: true; rotateOnPinch: true; scaleOnPinch: true"

      sound="src: #batida; autoplay: true; loop: true; volume: 0.7; positional: false"
    >
    </a-entity>

  </a-marker>

</a-scene>

<script>

// ================================
// ‚ù§Ô∏è ANIMA√á√ÉO CONT√çNUA DE PULSO
// ================================
AFRAME.registerComponent('heart-beat', {
  init: function () {
    const el = this.el;

    // Escala base
    el.setAttribute('scale', '1.2 1.2 1.2');

    // Pulsa√ß√£o cont√≠nua
    el.setAttribute('animation__pulse', {
      property: 'scale',
      dir: 'alternate',
      dur: 700,
      loop: true,
      easing: 'easeInOutSine',
      to: '1.28 1.28 1.28'
    });

    // Batida mais forte ao tocar
    el.addEventListener('tap', () => {
      el.setAttribute('animation__boost', {
        property: 'scale',
        dur: 200,
        to: '1.38 1.38 1.38',
        easing: 'easeOutQuad'
      });

      setTimeout(() => {
        el.removeAttribute('animation__boost');
      }, 220);
    });
  }
});


// ======================================
// üëÜ CONTROLE DE 1 DEDO + ZOOM SUAVE
// ======================================
AFRAME.registerComponent('onefinger-control', {

  init: function () {
    const el = this.el;
    let lastX = 0;
    let isDragging = false;

    // Rota√ß√£o com 1 dedo
    el.sceneEl.addEventListener('onefingermove', (e) => {
      if (!el.object3D.visible) return;

      const deltaX = e.detail.position.x - lastX;

      const rot = el.getAttribute('rotation');
      el.setAttribute('rotation', {
        x: rot.x,
        y: rot.y - deltaX * 1.2,
        z: rot.z
      });

      lastX = e.detail.position.x;
      isDragging = true;
    });

    el.sceneEl.addEventListener('onefingerstart', (e) => {
      lastX = e.detail.position.x;
    });

    // Quando solta o dedo
    el.sceneEl.addEventListener('onefingerend', () => {

      if (isDragging) {
        isDragging = false;
        return;
      }

      // Emite evento de toque
      el.emit('tap');

      // Zoom pequeno suave
      el.setAttribute('animation__tapzoom', {
        property: 'scale',
        dur: 180,
        to: '1.35 1.35 1.35',
        easing: 'easeOutQuad'
      });

      setTimeout(() => {
        el.removeAttribute('animation__tapzoom');
      }, 200);
    });

  }
});

</script>

</body>
</html>
